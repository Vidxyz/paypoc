apiVersion: batch/v1
kind: CronJob
metadata:
  name: order-cleanup-cronjob
  namespace: order
spec:
  # Run every hour at 30 minutes past the hour (staggered to reduce overlap with cart/inventory cleanup)
  schedule: "30 * * * *"
  successfulJobsHistoryLimit: 0
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: kafka-producer
            image: apache/kafka:3.7.0
            command:
            - /bin/bash
            - -c
            - |
              echo "Publishing cleanup command to Kafka..."
              TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
              # Wait a bit for Kafka to be ready and topic to exist
              sleep 2
              echo "{\"type\":\"CLEANUP_STALE_ORDERS\",\"timestamp\":\"${TIMESTAMP}\"}" | \
              /opt/kafka/bin/kafka-console-producer.sh \
                --bootstrap-server ${KAFKA_BOOTSTRAP_SERVERS} \
                --topic order.commands \
                --max-block-ms 10000
              if [ $? -eq 0 ]; then
                echo "✓ Cleanup command published successfully"
              else
                echo "✗ Failed to publish cleanup command"
                exit 1
              fi
            env:
            - name: KAFKA_BOOTSTRAP_SERVERS
              value: "kafka-cluster-kafka-bootstrap.kafka.svc.cluster.local:9092"
          restartPolicy: OnFailure
